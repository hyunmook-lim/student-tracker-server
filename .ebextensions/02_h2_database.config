option_settings:
  aws:elasticbeanstalk:application:environment:
    SPRING_DATASOURCE_URL: jdbc:h2:file:/var/app/current/data/studentdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    SPRING_DATASOURCE_USERNAME: sa
    SPRING_DATASOURCE_PASSWORD: 
    SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
    SPRING_JPA_HIBERNATE_DDL_AUTO: update
    SPRING_JPA_SHOW_SQL: false

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/00_create_data_dir.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      mkdir -p /var/app/current/data
      chown webapp:webapp /var/app/current/data
      chmod 755 /var/app/current/data
      echo "data directory created"
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_backup_h2.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      if [ -f /var/app/current/data/studentdb.mv.db ]; then
        echo "H2 database file exists. Creating backup."
        cp /var/app/current/data/studentdb.mv.db /var/app/current/data/studentdb.mv.db.backup.$(date +%Y%m%d_%H%M%S)
        echo "Backup completed"
      else
        echo "H2 database file not found. Will be created new."
      fi
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_restore_h2.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      LATEST_BACKUP=$(ls -t /var/app/current/data/studentdb.mv.db.backup.* 2>/dev/null | head -1)
      if [ -n "$LATEST_BACKUP" ] && [ ! -f /var/app/current/data/studentdb.mv.db ]; then
        echo "Restoring H2 database from backup: $LATEST_BACKUP"
        cp "$LATEST_BACKUP" /var/app/current/data/studentdb.mv.db
        echo "Restore completed"
      else
        echo "No backup to restore or database file already exists."
      fi